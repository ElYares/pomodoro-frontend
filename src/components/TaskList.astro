---
interface Task {
  id: string;
  user_id: string;
  title: string;
  description: string;
  project_id: string;
  completed: boolean;
  created_at: string;
  updated_at: string;
  status?: string;
  pomodoros_completed?: number;
  total_focus_minutes?: number;
}

const { tasks = [], userId } = Astro.props as { tasks: Task[]; userId?: string };

// Helper para convertir status t√©cnico a texto legible (opcional)
const formatStatus = (status?: string) => {
  const map: Record<string, string> = {
    IN_PROGRESS: "En curso",
    PAUSED: "Pausada",
    COMPLETED: "Hecha",
    PENDING: "Pendiente"
  };
  return map[status || ""] || status;
};

// Helper para clases de estado (mantenemos tu l√≥gica base pero simplificada)
const getStatusClass = (status?: string) => {
  return status ? status.toLowerCase() : "pending";
};
---

<div class="task-container">
  <div class="header">
    <h2>Mis Tareas</h2>
    <span class="count-badge">{tasks.length}</span>
  </div>

  <div class="scroll-area">
    {tasks.length === 0 ? (
      <div class="empty-state">
        <p>No hay tareas activas</p>
        <span>¬°Hora de un caf√©! ‚òï</span>
      </div>
    ) : (
      tasks.map((task) => (
        <div
          class={`task-card ${getStatusClass(task.status)}`}
          data-id={task.id}
          data-task-id={task.id}
          data-user-id={userId ?? task.user_id}
          data-task-status={task.status}
        >
          {/* Cabecera de la tarjeta: Proyecto y Estado */}
          <div class="card-top">
            <span class="project-tag">
              <span class="hash">#</span>{task.project_id}
            </span>
            {task.status && (
              <span class="status-badge">
                {formatStatus(task.status)}
              </span>
            )}
          </div>

          {/* Cuerpo: T√≠tulo y Descripci√≥n */}
          <div class="card-body">
            <h3 class="task-title">{task.title}</h3>
            <p class="task-desc">{task.description}</p>
          </div>

          {/* Footer: M√©tricas */}
          <div class="card-footer">
            <div class="stat" title="Pomodoros completados">
              <span class="icon">üçÖ</span>
              <span>{task.pomodoros_completed ?? 0}</span>
            </div>
            <div class="stat" title="Tiempo total">
              <span class="icon">‚è±</span>
              <span>{task.total_focus_minutes ?? 0}m</span>
            </div>
          </div>
        </div>
      ))
    )}
  </div>
</div>

<style>
  /* --- Contenedor Principal --- */
  .task-container {
    width: 100%; /* Se adapta al padre, idealmente 280px-320px */
    max-width: 320px;
    height: 100%;
    background-color: #121212; /* Fondo muy oscuro */
    display: flex;
    flex-direction: column;
    padding: 16px;
    box-sizing: border-box;
    font-family: system-ui, -apple-system, sans-serif;
    color: #e4e4e7;
  }

  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    padding: 0 4px;
  }

  .header h2 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
    color: #ffffff;
  }

  .count-badge {
    background: #27272a;
    color: #a1a1aa;
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 600;
  }

  /* --- √Årea de Scroll --- */
  .scroll-area {
    display: flex;
    flex-direction: column;
    gap: 12px;
    overflow-y: auto;
    overflow-x: hidden; /* <--- AGREGA ESTO */
    padding: 2px;       /* <--- AGREGA ESTO (Opcional, ayuda con las sombras) */
    padding-bottom: 20px;
    /* Scrollbar fina */
    scrollbar-width: thin;
    scrollbar-color: #3f3f46 transparent;
  }
  
  .scroll-area::-webkit-scrollbar {
    width: 4px;
  }
  .scroll-area::-webkit-scrollbar-thumb {
    background-color: #3f3f46;
    border-radius: 4px;
  }

  /* --- Tarjeta de Tarea (Card) --- */
  .task-card {
    background: #1e1e20;
    border: 1px solid #2d2d30;
    border-radius: 12px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
  }

  .task-card:hover {
    background: #232326;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    border-color: #3f3f46;
  }

  /* Estados Seleccionado (L√≥gica existente) */
  .task-card.task-selected {
    border-color: #fbbf24; /* Amber-400 */
    box-shadow: 0 0 0 1px rgba(251, 191, 36, 0.2);
  }

  /* --- Estructura Interna de la Card --- */
  .card-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .project-tag {
    font-size: 0.7rem;
    color: #71717a;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
  }
  .project-tag .hash { color: #52525b; margin-right: 1px; }

  .status-badge {
    font-size: 0.65rem;
    padding: 2px 8px;
    border-radius: 6px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }

  .card-body {
    margin-bottom: 12px;
  }

  .task-title {
    font-size: 0.95rem;
    margin: 0 0 4px 0;
    font-weight: 600;
    line-height: 1.4;
    color: #f4f4f5;
  }

  .task-desc {
    font-size: 0.8rem;
    color: #a1a1aa;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* Limita a 2 l√≠neas */
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.4;
  }

  .card-footer {
    display: flex;
    gap: 12px;
    border-top: 1px solid #2d2d30;
    padding-top: 8px;
  }

  .stat {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.75rem;
    color: #71717a;
    font-feature-settings: "tnum"; /* N√∫meros monoespaciados si la fuente soporta */
  }
  
  .stat .icon { font-size: 0.9rem; opacity: 0.8; }

  /* --- Variantes de Color por Estado --- */
  
  /* En Progreso: Amarillo/√Åmbar */
  .task-card.in_progress .status-badge {
    background: rgba(251, 191, 36, 0.15);
    color: #fbbf24;
    border: 1px solid rgba(251, 191, 36, 0.2);
  }
  .task-card.in_progress:hover { border-color: rgba(251, 191, 36, 0.5); }

  /* Completado: Verde/Esmeralda */
  .task-card.completed {
    opacity: 0.75;
  }
  .task-card.completed .task-title {
    text-decoration: line-through;
    color: #71717a;
  }
  .task-card.completed .status-badge {
    background: rgba(52, 211, 153, 0.1);
    color: #34d399;
    border: 1px solid rgba(52, 211, 153, 0.2);
  }

  /* Pausado: Gris/Azulado */
  .task-card.paused .status-badge {
    background: rgba(148, 163, 184, 0.15);
    color: #94a3b8;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 30px 10px;
    color: #52525b;
    font-size: 0.9rem;
    border: 2px dashed #27272a;
    border-radius: 12px;
  }
</style>